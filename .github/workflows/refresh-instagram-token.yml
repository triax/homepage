name: Refresh Instagram Access Token

on:
  schedule:
    # æ¯æœˆ1æ—¥ã¨15æ—¥ã®åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    # æ—¥æœ¬æ™‚é–“ã§ã¯æ­£åˆ12æ™‚
    # 60æ—¥ã®æœ‰åŠ¹æœŸé™ã«å¯¾ã—ã¦30æ—¥ã”ã¨ã«æ›´æ–°
    - cron: '0 3 1,15 * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
    inputs:
      force:
        description: 'Force refresh even if token has many days remaining'
        required: false
        type: boolean
        default: false

jobs:
  refresh-token:
    runs-on: ubuntu-latest

    # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ã§å®Ÿè¡Œ
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install libsodium-wrappers
        run: |
          npm install libsodium-wrappers

      - name: Refresh Instagram token
        env:
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "ğŸ”„ Attempting to refresh Instagram access token..."
          npm run instagram:refresh-token

      - name: Verify token update
        env:
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
        run: |
          echo "ğŸ” Verifying new token works..."
          # ç°¡å˜ãªAPIã‚³ãƒ¼ãƒ«ã§ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹ç¢ºèª
          curl -s "https://graph.facebook.com/v22.0/${IG_USER_ID}?fields=id&access_token=${IG_ACCESS_TOKEN}" | grep -q '"id"' && echo "âœ… Token is valid" || (echo "âŒ Token validation failed" && exit 1)

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Instagram Access Tokenæ›´æ–°å¤±æ•— - ${today}`,
              body: `## Instagram Access Tokenã®è‡ªå‹•æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n### å¯¾å¿œãŒå¿…è¦ã§ã™\n1. [Facebook Developers](https://developers.facebook.com/)ã«ãƒ­ã‚°ã‚¤ãƒ³\n2. æ–°ã—ã„Long-lived Access Tokenã‚’æ‰‹å‹•ã§ç”Ÿæˆ\n3. GitHub Secretsã®\`IG_ACCESS_TOKEN\`ã‚’æ›´æ–°\n\n### å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\n- [instagram-secrets-setup.md](knowledge/04-operations/instagram-secrets-setup.md)\n\n### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ\n- [å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'instagram', 'urgent']
            });