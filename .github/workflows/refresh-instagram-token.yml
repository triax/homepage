name: Refresh Instagram Access Token

on:
  schedule:
    # 毎月1日と15日の午前3時（UTC）に実行
    # 日本時間では正午12時
    # 60日の有効期限に対して30日ごとに更新
    - cron: '0 3 1,15 * *'
  workflow_dispatch: # 手動実行も可能にする
    inputs:
      force:
        description: 'Force refresh even if token has many days remaining'
        required: false
        type: boolean
        default: false

jobs:
  refresh-token:
    runs-on: ubuntu-latest

    # mainブランチのみで実行
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install libsodium-wrappers
        run: |
          npm install libsodium-wrappers

      - name: Refresh Instagram token
        env:
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "🔄 Attempting to refresh Instagram access token..."
          npm run instagram:refresh-token

      - name: Verify token update
        env:
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
        run: |
          echo "🔍 Verifying new token works..."
          # 簡単なAPIコールでトークンが有効か確認
          curl -s "https://graph.facebook.com/v22.0/${IG_USER_ID}?fields=id&access_token=${IG_ACCESS_TOKEN}" | grep -q '"id"' && echo "✅ Token is valid" || (echo "❌ Token validation failed" && exit 1)

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `⚠️ Instagram Access Token更新失敗 - ${today}`,
              body: `## Instagram Access Tokenの自動更新に失敗しました\n\n### 対応が必要です\n1. [Facebook Developers](https://developers.facebook.com/)にログイン\n2. 新しいLong-lived Access Tokenを手動で生成\n3. GitHub Secretsの\`IG_ACCESS_TOKEN\`を更新\n\n### 参考ドキュメント\n- [instagram-secrets-setup.md](knowledge/04-operations/instagram-secrets-setup.md)\n\n### ワークフロー実行\n- [実行ログを確認](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'instagram', 'urgent']
            });