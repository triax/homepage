# Instagram連携に関する技術的決定事項

## 決定日: 2025-08-25

### 1. 投稿更新頻度を12時間ごとに設定

#### 背景
- Instagram Graph APIのmedia_urlは24-48時間で期限切れになる
- 投稿IDベースの比較では、URLの更新が行われない問題が発生

#### 決定
- 2時間ごとから12時間ごとに変更
- 毎回必ずposts.jsonを更新（比較ロジックを削除）
- git diffで実際の変更を検出してコミット判定

#### 理由
- media_url有効期限に対する十分な安全マージン
- APIレート制限の考慮
- システムリソースの効率的な利用

### 2. トークン更新の自動化

#### 背景
- Long-lived Access Tokenは60日で期限切れ
- 手動更新は忘れやすく、サービス停止のリスク

#### 決定
- 月2回（1日と15日）自動更新
- GitHub Secrets APIを使用した自動更新
- ローカル環境では.envファイルを更新

#### 理由
- 60日期限の半分（30日）で更新することで安全性確保
- 完全自動化によるヒューマンエラーの排除
- 環境別の適切な保存先

### 3. libsodium-wrappersの採用

#### 背景
- GitHub Secrets APIは暗号化された値のみ受け付ける
- Node.js組み込みcryptoではcrypto_box_sealをサポートしていない

#### 決定
- libsodium-wrappersをdevDependenciesに追加
- 動的インポートで必要時のみロード

#### 理由
- GitHub APIの要求仕様に完全準拠
- セキュリティの専門性を持つ成熟したライブラリ
- 暗号化の自作は危険

### 4. 実行環境の判定方法

#### 背景
- GitHub ActionsとLocal環境で異なる処理が必要

#### 決定
- `process.env.GITHUB_ACTIONS === "true"`で判定
- 入力元と出力先を明確にログ出力

#### 理由
- GitHub Actionsが自動設定する環境変数を利用
- シンプルで確実な判定方法

### 5. エラー時の対応方針

#### 背景
- トークン更新失敗はサービス停止に直結

#### 決定
- GitHub Issueの自動作成
- urgentラベルの付与
- 手動対応手順の記載

#### 理由
- 即座の気付きと対応を促進
- 手順の明文化により誰でも対応可能
- 履歴の追跡が容易

## 今後の検討事項

### トークン管理の改善
- 複数トークンの管理方法
- トークン有効期限のSlack通知
- バックアップトークンの自動切り替え

### パフォーマンス最適化
- 投稿データのキャッシュ戦略
- 画像の事前ダウンロード
- CDN利用の検討

## 関連ドキュメント
- [アーキテクチャ](../02-architecture/instagram-integration.md)
- [運用手順](../04-operations/instagram-token-refresh.md)
- [トラブルシューティング](../05-troubleshooting/instagram-issues.md)