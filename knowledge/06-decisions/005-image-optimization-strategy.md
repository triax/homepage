# 画像最適化戦略の決定

**日付**: 2024年8月22日
**ステータス**: 承認済み
**関係者**: 開発チーム

## 背景

ウェブサイトのパフォーマンス改善のため、画像ファイルの最適化が必要でした。
特に以下の課題がありました：

1. メンバー画像137枚で合計260MBという大きなファイルサイズ
2. ギャラリー画像やヘッダー画像も未最適化
3. 複数の最適化スクリプトが存在し、管理が煩雑
4. EXIF情報の削除により画像が回転してしまう問題

## 決定事項

### 1. 統合最適化スクリプトの採用

**決定**: 個別のスクリプトを廃止し、`optimize-images.sh`に統合

**理由**:
- 保守性の向上
- 一貫性のある最適化設定
- ターゲットディレクトリに応じた自動設定

### 2. EXIF方向の適切な処理

**決定**: `-auto-orient`フラグを使用してEXIF情報を物理的に適用してから削除

**理由**:
- 画像の向きを正しく保持
- メタデータ削除によるファイルサイズ削減
- ブラウザ互換性の向上

### 3. 画像種別ごとの最適化パラメータ

**決定**: 用途に応じて異なる設定を適用

| 画像種別 | 最大幅 | 品質 | リネーム | 理由 |
|---------|-------|------|---------|------|
| メンバー | 800px | 85% | なし | 小さいサムネイル表示が主 |
| ギャラリー | 1920px | 85% | 連番 | フルスクリーン表示対応 |
| ヘッダー | 1920px | 90% | なし | 高品質維持が重要 |
| スポンサー | 600px | 85% | なし | ロゴの視認性確保 |

### 4. バックアップ戦略

**決定**: Gitによるバージョン管理に依存し、別途バックアップは作成しない

**理由**:
- Gitで完全な履歴管理が可能
- 不要なファイルの増加を防ぐ
- `git checkout`で簡単に復元可能

### 5. スキップ閾値の設定

**決定**: 500KB以下のファイルは最適化をスキップ

**理由**:
- 既に最適化済みファイルの再処理を防ぐ
- 処理時間の短縮
- 不要な品質劣化を避ける

## 実装の詳細

### ImageMagickコマンドの構成

```bash
magick "$file" \
    -auto-orient \              # EXIF方向を適用
    -resize "${MAX_WIDTH}>" \   # 幅が指定値を超える場合のみリサイズ
    -quality $QUALITY \         # JPEG品質
    -interlace Plane \          # プログレッシブJPEG
    -strip \                    # メタデータ削除
    -sampling-factor 4:2:0 \    # クロマサブサンプリング
    "$output_file"
```

### dry-runモードの実装

変更前にプレビューできるdry-runモードを実装：
- ファイルサイズの予測表示
- 処理対象ファイルのリスト表示
- 削減率の推定値表示

## 結果

### パフォーマンス改善

1. **総ファイルサイズ**: 299MB → 34.6MB（88%削減）
2. **ページ読み込み速度**: 大幅に改善
3. **ユーザー体験**: モバイルでの表示速度向上

### 運用改善

1. **スクリプト管理**: 4つのスクリプトを1つに統合
2. **実行の簡素化**: 統一されたインターフェース
3. **保守性**: 設定の一元管理

## 今後の検討事項

1. **WebP形式への対応**: さらなるファイルサイズ削減の可能性
2. **自動化**: GitHub Actionsでの自動最適化
3. **CDN活用**: 画像配信の最適化
4. **遅延読み込み**: ページ初期表示の高速化

## 関連ドキュメント

- [画像最適化ガイド](../04-operations/image-optimization.md)
- [ギャラリー管理](../04-operations/gallery-management.md)
- [EXIF方向問題の解決](../05-troubleshooting/exif-orientation-issue.md)